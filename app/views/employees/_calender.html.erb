<script>
	$(document).ready(function() {
		$('.calendar-picture').click(function() {
			var name = "#"+$(this).attr('full_image');
			$(name).show();
			
	    });
		
		$('.full-image-bg').click(function() {
			$(this).hide();
		});
		
		$('.time_sheet_action_link').click(function(e) {
		    e.preventDefault();
		    //do other stuff when a click happens
			//link: work_durations/update_duration_status
			// id="time_sheet_action_link"
			// action="reject"
			//alert("Hallo me friendo");
			
			
			var link = $(this).prop("href");
			var status = $(this).attr("action");
			var id = $(this).attr("action_id");
			var status_div = $(this).attr("status_div");
			
			//alert(link + " - " + status + " - " + id);
			$("#action_buttons_container_"+id).hide();
			$("#action_loader_container_"+id).show();
			
			$.ajax({
 			  url: link,
 			  type: 'PUT',
			  beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
 			  data: "status="+status+"&action_id="+id,
 			  success: function(data) {
 			    
				  				
				if($.trim(data["result"]) == "true"){
	  				$("#action_buttons_container_"+data["id"]).hide();
	  				$("#action_loader_container_"+data["id"]).hide();
					
					//alert("status div: status-div-"+data["id"]);
					
					$("#status-div-"+data["id"]).html(data["status"].toUpperCase());
					$("#status-div-"+data["id"]).removeClass('pending');
					$("#status-div-"+data["id"]).addClass(data["status"]);
				} else {
					alert("Failed to update status. Please try again.");
					$("#action_buttons_container_"+data["id"]).show();
					$("#action_loader_container_"+data["id"]).hide();
				}
				
 			  },
			  error: function (data) {
   			    alert('Failed to update status.' + JSON.stringify(data));
  				$("#action_buttons_container_"+data["id"]).show();
  				$("#action_loader_container_"+data["id"]).hide();
              }
			  
			});
		});
	});
</script>
	
	<%= csrf_meta_tag %>
	<% if !defined?(can_update) %>
	<% can_update = false %>
	<% end %>
	
	<% if !defined?(can_act) %>
	<% can_act = false %>
	<% end %>
	
	<% if !defined?(show_unsubmitted) %>
	<% show_unsubmitted = true %>
	<% end %>
	
	<% if !defined?(show_employee_info) %>
	<% show_employee_info = true %>
	<% end %>
	
<% today = Date.today # Today's date %>
<% @days_from_this_week = (today.at_beginning_of_week..today.at_end_of_week).map %> 
<div class="info_print_employee">
    <%# link_to "Print",employee_report_employees_url(eid:@employee.id,from_date:@from_date,to_date:@to_date,format: "pdf"),class: "btn"%>
</div>
<div class="row top">
<!--   <div class="col col20">
    Vendor
  </div> -->
  <div class="col col-5">
    Time Period
  </div>
  <% if show_employee_info %>
  <div class="col col8">
    Employee
  </div>
  <div class="col col8">
    Vendor
  </div>
  <% end %>
  <% for day in (today.at_beginning_of_week..today.at_end_of_week).to_a.take(5).map.each { |day| day } do %>
    <div class="col col8">
      <%# day.strftime("%a %d") %>
	  <%= day.strftime("%a") %>
    </div>
  <% end %>
  <div class="col col8">
    Total Hours
  </div>
  <div class="col col8">
    Timesheet / Screenshot
  </div>
  <div class="col col8">
    Status
  </div>
  
  <% if can_act %>
  <div class="col col12">
    Actions
  </div>       
  <% end %>
  
  <div style="clear:both"></div>
</div>

<% employees.each do |employee| %>
<% employee.projects.each do |p| %>
	<% start_date = params["from_date"] ? DateTime.parse(params["from_date"]) : DateTime.now - 5 %>
	<% end_date = params["to_date"] ? DateTime.parse(params["to_date"]) : DateTime.now %>
	<% work_days =  p.work_durations.where(work_day: start_date..end_date) %>
	<% if !show_unsubmitted %>
		<% work_days = work_days.where.not(time_sheet_status: "saved").where.not(time_sheet_status: "unsubmitted") %>
	<% end %>
	<% work_days = work_days.order(:work_day).reverse %>

	<% loop_date = end_date %>

	<% loop_index = 1 %>

	<% loop do %>
		<% break if work_days.count <= 0 %>
		<% loop_start  = loop_date.at_beginning_of_week %>
		<% loop_end    = loop_date.at_end_of_week - 2 %>
		<% if p.work_durations.where(:work_day => loop_start).count > 0 %>
			<%# week_status = p.work_durations.where(:work_day => loop_start).first.time_sheet_status %>
			<% week_wds    = p.work_durations.where(:work_day => loop_start..loop_end).order(:work_day) %>
			<%# passed_due_date = (DateTime.now - week_wds.first.work_day).to_i >= 14  %>
		<% else %>
			<% loop_date = loop_date.at_beginning_of_week - 1 %>
			<% next  %>
		<% end %>
		
		<%# "Start: " + loop_start.strftime("%B %d, %Y, %A") + "End:" + loop_end.strftime("%B %d, %Y, %A") %> 
		
		<% if week_wds.first.is_pending? || week_wds.first.is_approved? %>
		
			<div class="parent" data-index="1">
				<div class="row">
					
			        <div class="col col-5 mt-3">
			          <%= (loop_start - 1).strftime("%b %d, %Y") %> - <%= (loop_end + 1).strftime("%b %d, %Y") %>
					  <br />
					  <% if week_wds.first.is_pending? || week_wds.first.is_approved? || week_wds.first.is_rejected? %>
					  <span style="font-size:10px;color:#6E6E66">(<b>Submitted:</b> <%= week_wds.first.created_at.strftime("%b %d, %Y") %>)</span>
					  <% end %>
			        </div>
				    <% if show_employee_info %>
				    <div class="col col8 mt-3">
				      <%= p.employee.profile.full_name %>
				    </div>
				    <div class="col col8 mt-3">
				      <%= p.vendor.profile.full_name %>
				    </div>
				    <% end %>
					
					<% week_wds.each do |wd| %>
						<div class="col col8 ">
				          <label class="mt-3 label-duration-1" for="work_duration_a1">
				          	<%= wd.hours %> 
				          </label>
				        </div>
					<% end %>
					
					<div class="col col8 ">
			          <label class="mt-3 label-duration-1" for="work_duration_a1">
			          	<%= week_wds.map{|wd|wd.hours}.inject(0, :+) %>
			          </label>
			        </div>
					
					<div class=" col col8">
						<div class="calendar-picture" full_image="full-image-bg-<%=loop_index%>">
							<% if week_wds.count > 0 %>
							<img src="<%= week_wds.first.timesheet_screenshot.attached? ? week_wds.first.timesheet_screenshot.url : "" %>" class="picture-src" id="wizardPicturePreview" title="Timesheet">
							<% else %>
							<img src="" class="picture-src" id="wizardPicturePreview" title="Unavailable">
							<% end %>
						</div>
					</div>
					
					<div class="full-image-bg" id="full-image-bg-<%=loop_index%>" style="display:none">
						<div class="full-image">
							<% if week_wds.count > 0 %>
							<img src="<%= week_wds.first.timesheet_screenshot.attached? ? week_wds.first.timesheet_screenshot.url : ""  %>" class="picture-src" id="wizardPicturePreview" title="Timesheet">
							<% else %>
							<img src="" class="picture-src" id="wizardPicturePreview" title="Unavailable">
							<% end %>
						</div>
					</div>
					
					<% if week_wds.count > 0 %>
		            <div class="col col8 mt-3 <%= week_wds.first.time_sheet_status %>" id="status-div-<%=week_wds.first.id%>" style="<%= week_wds.first.is_past_due_date? ? "margin-top: 0.3rem !important;" : "" %>">
					  <% if week_wds.first.is_past_due_date? %>
						<label style="color:red">
							PASSED DUE DATE
						</label>
					  <% else %>
					  	<%= week_wds.first.time_sheet_status.upcase %>
					  <% end %>
					  
		            </div>
					<% else %>
					<div class="col col8 mt-3 ">unsubmitted</div>
					<% end %>
					
					<% if can_act %>
					<% if week_wds.count > 0 %>
				    <div class="col col12">
							<% if !week_wds.first.is_past_due_date? && week_wds.first.time_sheet_status == "pending" %>
					  <div class="action_buttons_parent" id="action_buttons_container_<%=week_wds.first.id%>">
					      <div class="action_button_container approve">
							  <div class="action_button_div">
								  <a href="/work_durations/update_duration_status" class="time_sheet_action_link" action="approved" action_id="<%=  week_wds.first.id %>"> 
									  <i class="material-icons time_sheet_action">check_circle</i> 
								  </a>
							  </div>
							  <div class="action_button_title">
								  Approve
							  </div>
						  </div>
					  
					      <div class="action_button_container reject">
							  <div class="action_button_div">
								  <a href="/work_durations/update_duration_status" class="time_sheet_action_link" action="rejected" action_id="<%=  week_wds.first.id %>">
									  <i class="material-icons time_sheet_action">cancel</i>
								  </a>
							  </div>
							  <div class="action_button_title">
								  Reject
							  </div>
						  </div>
					  </div>
					  
				      <div class="action_button_container" id="action_loader_container_<%=week_wds.first.id%>" style="display:none">
						  <div class="action_button_div">
							  <div class="loader"></div>
						  </div>
						  <div class="action_button_title">
							  Updating Status. Please wait.
						  </div>
					  </div>
					  	<% end %>
					  <div class="clr"></div>
				    </div>
					<% else %>
					<div class="col col12 ">unsubmitted</div>
					<% end %>
					<% end %>
					
				</div>
			</div>
	
		<% elsif can_update %> 

			<%= form_tag work_durations_path, multipart: true, style: "margin:0px;width:100%;padding:0px;"  do %>
			<div class="parent-toggle" data-index="<%=loop_index%>">
		
				<div class="row">
					
			        <div class="col col-5 mt-3">
			          <%= (loop_start - 1).strftime("%b %d, %Y") %> - <%= (loop_end + 1).strftime("%b %d, %Y") %>
			        </div>
				    
					<% if show_employee_info %>
				    <div class="col col8 mt-3">
				      <%= p.employee.profile.full_name %>
				    </div>
				    <div class="col col8 mt-3">
				      <%= p.vendor.profile.full_name %>
				    </div>
				    <% end %>
					
					<% week_wds.each do |wd| %>
					
						<div class="col col8 labeled-toggle-<%=loop_index%>">
				          <label class="mt-3 " for="work_duration_a1">
							  <%= wd.hours %>
				          </label>
				        </div>
						<div class="col col8 field-toggle-<%=loop_index%>" style="display:none">
				          <label class="mt-3 label-duration-1" for="work_duration_a1">
				          	<%= number_field_tag :thought_author, "", :name => "wds[][#{wd.work_day.strftime("%b,%d,%Y")}]", :value => wd.hours, :min=>"0", :max=>"12", :style=>"min-width:60px" %> <br />
				          </label>
				        </div>
					<% end %>
					<div class="col col8">
			          <label class="mt-3 label-duration-1" for="work_duration_a1">
			          	<%= week_wds.map{|wd|wd.hours}.inject(0, :+) %>
			          </label>
			        </div>
					
					<div class=" col col8">
						<div class="calendar-picture" full_image="full-image-bg-<%=loop_index%>">
							<img src="<%= week_wds.first.timesheet_screenshot.attached? ? week_wds.first.timesheet_screenshot : ""  %>" class="picture-src" id="wizardPicturePreview" title="">
						</div>
					</div>
					
					<div class="full-image-bg" id="full-image-bg-<%=loop_index%>" style="display:none">
						<div class="full-image">
							<img src="<%= week_wds.first.timesheet_screenshot.attached? ? week_wds.first.timesheet_screenshot : ""  %>" class="picture-src" id="wizardPicturePreview" title="">
						</div>
					</div>
			
		            <div class="col col8 mt-3 <%= week_wds.first.time_sheet_status %>">
		              <%= week_wds.first.time_sheet_status.upcase %>
		            </div>
					<% if can_act %>
					<div class="col col12">
					</div>
					<% end %>
			
				</div>
				<div class="row" id="toggle-row-<%=loop_index%>" style="display:none;">
		            <div class="section">
		              <div>
		                <label for="file">
		                  <b>Upload timesheet/screenshot</b>
		                </label> 
		                <br/>
						<%= file_field_tag :timesheet_screenshot, :style=>"width:100%" %>
		              </div>
		              <b> Certification </b> 
		              <br/>
		              <ul>
		                <li> By submitting this, I agree that the information provided in the screen is accurate.I certify 
		                  that the company has all the breaks as agreed upon.
		                </li>
		              </ul>
		            </div>
			
		            <div class="section actions">
		              <%# form.submit "Submit",class: "btn btn-primary",style: "width:35%;" %>
		              <% if @employee != nil %>
		                <%= hidden_field_tag :eid, @employee.id %>
		                <%= hidden_field_tag :pid, p.id %>
						<%# hidden_field_tag :date,:value=> date %>
		              <% end %>
					  
					  
		              <%= submit_tag "Submit", class: "btn btn-primary", style: "width:35%;" %> 
					  <%= submit_tag "Save For Later", name: "save_for_later", class: "btn btn-primary", style:"width:61%;margin-right:4%;" %>
			 		  
					  <%# submit_tag "Submit", :style=>"min-width:100px" %>
		            </div>
		            <div class="clr"></div>
  			
				</div>
		
			</div>
			<% end %>
	
			
		<% end %>
		
		<% loop_index += 1 %>
		<% loop_date = loop_date.at_beginning_of_week - 1 %>
		<% break if loop_date < work_days.last.work_day %>
	<% end %>

<% end %>

<% end %>
 
 
 <% if false %>
 
 <%@work_durations.each_with_index do |work,index| %>
    <%
      
      toggle_class = index <= 1 || work.second.first.time_sheet_status == "rejected" ? "parent-toggle" : ""
      background_color = index <= 1 || work.second.first.time_sheet_status == "rejected" ? "" : "#efefef"
      parent_index=index
    %>
    <%= form_with(model: WorkDuration.new, local: true, html: {class: "calender-form"}) do |form| %>
      <div class= "<%=toggle_class%>" data-index="<%=parent_index+1%>">
        <div class="row" style="background-color:<%=background_color%>">
          <div class="col col20 mt-3">
            <%date = work.second.first.work_day.beginning_of_week.strftime("%B %d, %Y")%>
            <%= date %>
          </div>
          
          <% (today.at_beginning_of_week..today.at_end_of_week).to_a.take(5).map.each { |day| day }.each_with_index do |day, index| %>
            <% hw = work.second.select{|w| w if w.work_day.strftime("%A") == day.strftime("%A")} %>
            <%
              current_status = hw.first.time_sheet_status
              toggle_label_class = current_status == "unsubmitted" || current_status == "saved" || current_status == "rejected" ? "labeled-toggle-#{parent_index + 1}": ""
              toggle_field_class = current_status == "unsubmitted" || current_status == "saved" || current_status == "rejected" ? "field-toggle-#{parent_index + 1}" : ""
            %>
            <div class="col col8 <%=toggle_label_class%>">
              <%= form.label ["a","b","c","d","e","f","g"][index]+work.first.third.to_s, hw.count > 0 ? hw.first.hours : 0,class: "mt-3 label-duration-#{parent_index+1}" %>
            </div>
            <div class="col col8 field-toggle <%=toggle_field_class%>">
             <%= form.number_field ["a","b","c","d","e","f","g"][index]+work.first.third.to_s,in: 0..12,class: "value_duration emp-duration-#{parent_index+1}",:value => hw.count > 0 ? hw.try(:first).try(:hours) : 0, :data => {index: parent_index+1} %>
            </div>
            <% if index == 4 %>
              <div class="col col6">
                <%= form.label "#{work.second.last(5).collect(&:hours).compact.inject(:+)}",class: "mt-3", id: "total-hours-#{parent_index+1}" %>
              </div>
              <div class=" col col6">
                <div class="calendar-picture">
                  <img src="<%= work.try(:second).try(:last).try(:timesheet_screenshot).try(:url) %>" class="picture-src" id="wizardPicturePreview" title="">
                </div>
              </div>
              <div class="col col9">
                <%= form.label "#{work.try(:second).try(:second_to_last).try(:time_sheet_status)}",nil,class:"mt-3 #{work.try(:second).try(:second_to_last).try(:time_sheet_status)}" %>
              </div>
            <% end %>
			
          <% end %>

          <div style="clear:both"></div>
        </div>
        <div class="row" id="toggle-row-<%=parent_index+1%>" style="display:none;">
          <div class="section">
            <div>
              <label for="file">
                <b>Upload timesheet/screenshot</b>
              </label> 
              <br/>
              <%= form.file_field :timesheet_screenshot,required: true %>
            </div>
            <b> Certification </b> 
            <br/>
            <ul>
              <li> By submitting this, I agree that the information provided in the screen is accurate.I certify 
                that the company has all the breaks as agreed upon.
              </li>
            </ul>
          </div>
            <% if @employee != nil %>
              <%= form.hidden_field :eid, :value => @employee.id %>
              <%= form.hidden_field :date,:value=> date %>
            <% end %>
            <div class="section actions">
              <%= form.submit "Submit",class: "btn btn-primary",style: "width:35%;" %>
              <%= form.submit "Save For Later",name: "save_for_later",class: "btn btn-primary",style:"width:61%;margin-right:4%;" %>
            </div>
            <div class="clr"></div>
        </div>
      </div>
	  
    <% end %>
 <% end %>
 <% if @work_durations.empty?%>
   <div class="row">
     <div class="col col4">
     </div>
     <div class="col col20">
     </div>
     <div class="col col20">
     </div>
     <% (today.at_beginning_of_week..today.at_end_of_week).map.each { |day| day }.each_with_index do |day, index| %>
       <div class="col col8">
         <%= label_tag "" %>
       </div>
       <div class="col col6">
         
       </div>
       <% if index == 6 %>
         <div class="col col9">
           <%= label_tag "" %>
         </div>
       <% end %>
     <% end %>
     <div style="clear:both"></div>
   </div>
 <%end%>

<% end %>